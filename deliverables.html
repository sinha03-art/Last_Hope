<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gate Deliverables — Board</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  :root{ --bg:#f6f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#e11d48; --border:#e5e7eb; }
  html,body{height:100%}
  body{font-family:"Lato",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink);}
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:.75rem; }
  .col{ background:var(--panel); border:1px dashed var(--border); border-radius:.75rem; min-height: 180px; }
  .badge{ font-size:.7rem; padding:.15rem .45rem; border-radius:999px; font-weight:700 }
  .badge-Approved{ background:#d1fae5; color:#065f46 }
  .badge-Submitted{ background:#fef3c7; color:#92400e }
  .badge-Missing{ background:#e5e7eb; color:#374151 }
  .badge-Rejected{ background:#fee2e2; color:#991b1b }
  .card-item{ border:1px solid var(--border); border-radius:.5rem; padding:.6rem .7rem; background:#fff; transition: box-shadow .15s ease }
  .card-item:hover{ box-shadow: 0 6px 14px rgba(0,0,0,.06) }
  .header-actions a{ text-decoration: underline; text-underline-offset: 2px; }
  .sticky-header{ position: sticky; top: 0; background: var(--bg); z-index: 10; padding-top: 0.5rem; padding-bottom: 0.5rem; }
  #ownerChips button.active{ background:#0f1723; color:#fff; border-color:#0f1723 }
  </style>
</head>
<body class="p-4 md:p-6">
<header class="sticky-header">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <h1 class="text-2xl font-black uppercase">Gate Deliverables — Board</h1>
    <div class="header-actions flex flex-wrap items-center gap-3">
      <input id="q" class="px-3 py-2 rounded border border-slate-300 text-sm" placeholder="Search title or assignee">
      <select id="gateFilter" class="px-3 py-2 rounded border border-slate-300 text-sm">
        <option value="">All gates</option>
      </select>
      <div class="flex gap-2" id="ownerChips">
        <button class="px-3 py-1 text-xs rounded border hover:bg-slate-50" data-owner="solomon">Solomon</button>
        <button class="px-3 py-1 text-xs rounded border hover:bg-slate-50" data-owner="harminder">Harminder</button>
        <button class="px-3 py-1 text-xs rounded border hover:bg-slate-50" data-owner="">Both</button>
      </div>
      <a href="" target="_blank" class="px-3 py-2 rounded bg-rose-600 text-white text-sm font-bold hover:bg-rose-700">Upload</a>
    </div>
  </div>
</header>

<main id="root" class="mt-4 space-y-8"></main>

<script>
const STATUS_ORDER = ['Missing','Submitted','Rejected','Approved'];
const STATUS_TITLES = { Missing:'Missing', Submitted:'Submitted', Rejected:'Rejected', Approved:'Approved' };

let dataCache;
let ownerFilter = ''; // '', 'solomon', 'harminder'

function byGate(list){ const m={}; list.forEach(d=>{ const g=d.gate||'Uncategorized'; (m[g] ||= []).push(d); }); return m; }
function byStatus(list){ const m={Missing:[],Submitted:[],Rejected:[],Approved:[]}; list.forEach(d=>{ const s=STATUS_ORDER.includes(d.status)?d.status:'Missing'; m[s].push(d); }); return m; }
function counts(list){ const c={total:list.length,Approved:0,Submitted:0,Missing:0,Rejected:0}; list.forEach(d=> c[d.status]=(c[d.status]||0)+1 ); return c; }
function matchQuery(d,q){ if(!q)return true; const t=(d.title||'').toLowerCase(); const owners=(d.assignees||[]).join(' ').toLowerCase(); return t.includes(q)||owners.includes(q); }

function gateHeader(g, items){
  const c = counts(items);
  return `
    <div class="flex items-end justify-between mb-3">
      <div>
        <h2 class="text-xl font-black">${g}</h2>
        <p class="text-xs text-slate-500">
          Required: ${c.total}
          • Approved: ${c.Approved}
          • Submitted: ${c.Submitted}
          • Missing: ${c.Missing}
          • Rejected: ${c.Rejected}
        </p>
      </div>
      <div class="text-xs text-slate-500">Last updated: ${new Date().toLocaleString()}</div>
    </div>`;
}

function itemCard(d){
  const owners = (d.assignees && d.assignees.length) ? d.assignees.join(', ') : '—';
  const badgeClass = 'badge badge-' + (STATUS_ORDER.includes(d.status) ? d.status : 'Missing');
  return `
    <a href="${d.url}" target="_blank" class="card-item block">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <p class="font-bold truncate">${d.title}</p>
          <p class="text-xs text-slate-500 mt-1">Assignees: ${owners}</p>
        </div>
        <span class="${badgeClass}">${d.status || 'Missing'}</span>
      </div>
    </a>`;
}

function column(title, items){
  return `
    <div class="col p-3">
      <div class="flex items-center justify-between mb-2">
        <p class="text-xs font-bold text-slate-600">${title}</p>
        <span class="text-[10px] text-slate-500">${items.length}</span>
      </div>
      <div class="space-y-2">
        ${items.map(itemCard).join('')}
      </div>
    </div>`;
}

function setOwnerFilter(v){
  ownerFilter = (v || '').toLowerCase();
  document.querySelectorAll('#ownerChips [data-owner]').forEach(btn=>{
    btn.classList.toggle('active', (btn.dataset.owner || '').toLowerCase() === ownerFilter);
  });
  render();
}

function render(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const gateSel = document.getElementById('gateFilter').value;

  let list = (dataCache.deliverables || []).slice();
  if (q) list = list.filter(d => matchQuery(d, q));
  if (gateSel) list = list.filter(d => (d.gate || 'Uncategorized') === gateSel);

  if (ownerFilter) {
    const key = ownerFilter.toLowerCase();
    list = list.filter(d => (d.assignees || []).some(a => (a || '').toLowerCase().includes(key)));
  }

  const grouped = byGate(list);
  const gates = Object.keys(grouped).sort((a,b)=> a.localeCompare(b));
  const root = document.getElementById('root'); root.innerHTML='';

  if (gates.length === 0){
    root.innerHTML = `<div class="text-slate-500 text-sm">No deliverables match your filter.</div>`;
    return;
  }

  gates.forEach(gate => {
    const items = grouped[gate];
    const statusGroups = byStatus(items);
    const board = `
      <section>
        ${gateHeader(gate, items)}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          ${STATUS_ORDER.map(s => column(STATUS_TITLES[s], statusGroups[s])).join('')}
        </div>
      </section>`;
    root.insertAdjacentHTML('beforeend', board);
  });
}

async function load(){
  const res = await fetch('/.netlify/functions/proxy');
  if (!res.ok) throw new Error('Failed to load data');
  dataCache = await res.json();

  const gates = Array.from(new Set((dataCache.deliverables||[]).map(d => d.gate || 'Uncategorized'))).sort();
  const sel = document.getElementById('gateFilter');
  gates.forEach(g => sel.insertAdjacentHTML('beforeend', `<option>${g}</option>`));

  document.querySelectorAll('#ownerChips [data-owner]').forEach(btn=>{
    btn.addEventListener('click', ()=> setOwnerFilter(btn.dataset.owner));
  });
  const urlOwner = new URLSearchParams(location.search).get('owner');
  if (urlOwner) setOwnerFilter(urlOwner);
  render();
}

document.getElementById('q').addEventListener('input', render);
document.getElementById('gateFilter').addEventListener('change', render);
load().catch(err=>{
  document.getElementById('root').innerHTML = `<div class="text-rose-600 text-sm">Error: ${err.message}</div>`;
});
</script>
</body>
</html>
