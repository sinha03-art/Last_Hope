<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Project Dashboard</title>

	<link rel="preconnect" href="https://fonts.googleapis.com/">
	<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com/"></script>

	<!-- Chart.js (UMD) -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>

	<style>
	:root{ --bg:#f1f3f5; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#e11d48; --nav:#0f2133; --nav-ink:#e2e8f0;}
	.dark { --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#93a3b8; --nav:#0b1220; --nav-ink:#e5e7eb; }
	html,body{height:100%}
	body{font-family:"Lato",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink);}
	.nav-sep{box-shadow: inset 0 -1px 0 0 rgba(255,255,255,0.06);}
	.pill{font-weight:800;font-size:.625rem; line-height:1; padding:.25rem .4rem; border-radius:999px; background:#ef4444; color:#fff;}
	.hr{height:1px; background: #e5e7eb;}
	.top-shadow{box-shadow: 0 1px 0 rgba(15,33,51,.06);}
	.kpi{border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem; background:var(--panel)}
	.card{background:var(--panel)}
	/* Chart area */
	#cashflowBox { height: 220px; }

	/* Payable / Blocked badges and reason lines */
	.badge { display:inline-block; font-size:.65rem; font-weight:700; line-height:1; padding:.2rem .45rem; border-radius:999px; }
	.badge-ok { background:#d1fae5; color:#065f46 }     /* Payable */
	.badge-warn { background:#fde68a; color:#92400e }   /* Upcoming blocked */
	.badge-stop { background:#fee2e2; color:#991b1b }   /* Overdue blocked */
	.reason { display:block; font-size:.72rem; color:#475569; margin-top:.15rem; }
	</style>
</head>
<body>
	<div class="min-h-screen grid grid-cols-[260px_1fr]">
		<aside class="bg-[var(--nav)] text-[var(--nav-ink)]">
			<div class="p-6 flex items-center gap-3">
				<div class="w-9 h-9 rounded bg-white/10 grid place-items-center"><div class="w-5 h-5 rotate-45 bg-[var(--brand)]"></div></div>
				<div class="leading-tight">
					<p class="font-black tracking-wide">JOOBIN</p>
					<p class="text-[10px] opacity-70">Assets</p>
				</div>
			</div>

			<nav class="mt-6 text-sm">
				<div class="px-6 py-3 text-[.8rem] tracking-widest uppercase opacity-60">Pages</div>
				<ul>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Dosier</span></a></li>
					<li class="nav-sep">
						<a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="/deliverables.html">
							<span>Gate Deliverables</span>
							<span class="pill">New</span>
						</a>
					</li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Project Stage</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Media</span><span class="pill">New</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Tasks</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Forms</span></a></li>
				</ul>
			</nav>
		</aside>

		<div class="flex flex-col">
			<header class="card top-shadow">
				<div class="h-14 flex items-center justify-between px-6">
					<p class="font-black tracking-wide">Dashboard</p>
					<div class="flex items-center gap-3">
						<button id="themeToggle" class="text-xs px-3 py-1 rounded border border-slate-300/50 hover:bg-slate-50 dark:hover:bg-slate-800">Dark</button>
						<div class="text-xs opacity-70">JOOBIN</div>
					</div>
				</div>
			</header>

			<main class="p-6 space-y-6">
				<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
					<div class="kpi">
						<p class="text-xs uppercase text-[var(--muted)]">Paid vs Budget</p>
						<p id="kpiPaidVsBudget" class="text-3xl font-black">0%</p>
						<!-- Optional doughnut: <canvas id="kpiPaidChart" height="80" style="width:100%;"></canvas> -->
					</div>

					<div class="kpi">
						<p class="text-xs uppercase text-[var(--muted)]">Deliverables Approved</p>
						<p id="kpiDeliverables" class="text-3xl font-black">0%</p>
					</div>

					<div class="kpi">
						<p class="text-xs uppercase text-[var(--muted)]">Milestones At Risk</p>
						<p id="kpiRisk" class="text-3xl font-black">0</p>
						<!-- Optional sparkline: <canvas id="riskSpark" height="40" style="width:100%;"></canvas> -->
					</div>

					<div class="kpi">
						<p class="text-xs uppercase text-[var(--muted)]">Next 30d Due</p>
						<p id="kpiNext30" class="text-3xl font-black">RM 0</p>
						<p id="kpiNext30Count" class="text-xs text-[var(--muted)] mt-1">0 items</p>
					</div>
				</section>

				<section class="grid grid-cols-12 gap-6">
					<div class="col-span-12 lg:col-span-6 card rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide mb-3">Attention Board</h3>
						<div class="grid md:grid-cols-2 gap-4">
							<div>
								<p class="text-xs uppercase text-[var(--muted)] mb-2">Overdue Payments</p>
								<ul id="overdueList" class="space-y-2 text-sm"></ul>
							</div>
							<div>
								<p class="text-xs uppercase text-[var(--muted)] mb-2">Upcoming (30d)</p>
								<ul id="upcomingList" class="space-y-2 text-sm"></ul>
							</div>
						</div>
						<div class="hr my-5"></div>
						<div class="grid md:grid-cols-2 gap-4">
							<div>
								<p class="text-xs uppercase text-[var(--muted)] mb-2">Deliverable Issues</p>
								<ul id="deliverableIssues" class="space-y-2 text-sm"></ul>
							</div>
							<div>
								<p class="text-xs uppercase text-[var(--muted)] mb-2">Milestones At Risk</p>
								<ul id="milestonesRisk" class="space-y-2 text-sm"></ul>
							</div>
						</div>
					</div>

					<div class="col-span-12 lg:col-span-6 card rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide mb-3">Cashflow (Scheduled vs Paid)</h3>
						<div id="cashflowBox" class="relative">
							<canvas id="cashflowChart" height="220" style="width:100%;"></canvas>
						</div>
					</div>
				</section>

				<section class="grid grid-cols-12 gap-6">
					<div class="col-span-12 xl:col-span-8 card rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide mb-3">Gate Progress</h3>
						<div id="gatesWrap" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
					</div>
					<div class="col-span-12 xl:col-span-4 card rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide mb-3">Top Vendors Outstanding</h3>
						<ul id="topVendors" class="space-y-2 text-sm"></ul>
					</div>
				</section>

				<section class="card rounded border border-slate-200 p-6">
					<div class="flex items-center justify-between">
						<h3 class="font-black tracking-wide">Weekly AI Summary</h3>
						<button id="genSummary" class="px-4 py-2 bg-rose-600 text-white font-bold rounded hover:bg-rose-700">Generate</button>
					</div>
					<div id="summaryOut" class="mt-4 text-sm whitespace-pre-line"></div>
				</section>

				<!-- Status line for fetch errors -->
				<div id="status" class="px-1 text-xs text-rose-600"></div>
			</main>
		</div>
	</div>

	<script>
	// THEME
	const btn = document.getElementById('themeToggle');
	function applyTheme(t){ document.body.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); btn.textContent = t==='dark' ? 'Light' : 'Dark'; }
	applyTheme(localStorage.getItem('theme') || 'light');
	btn.addEventListener('click', () => applyTheme(document.body.classList.contains('dark') ? 'light':'dark'));

	// HELPERS
	const fmtMYR = v => (v||0).toLocaleString('en-MY', { style:'currency', currency:'MYR', maximumFractionDigits:0 });
	const fmtDate = s => s ? new Date(s).toLocaleDateString('en-GB', { day:'2-digit', month:'short' }) : '—';

	let dataCache = null;

	function li(html){ const el=document.createElement('li'); el.className='flex justify-between gap-3'; el.innerHTML=html; return el; }

	// RENDERERS
	function renderKPIs(k){
		document.getElementById('kpiPaidVsBudget').textContent = (((k.paidVsBudget||0)*100).toFixed(1))+'%';
		document.getElementById('kpiDeliverables').textContent = (((k.deliverablesProgress||0)*100).toFixed(0))+'%';
		document.getElementById('kpiRisk').textContent = k.milestonesAtRisk||0;
		document.getElementById('kpiNext30').textContent = fmtMYR(k.next30?.amount||0);
		document.getElementById('kpiNext30Count').textContent = (k.next30?.count||0)+' items';
	}

	function renderAlerts(a){
		const overdue = document.getElementById('overdueList'); overdue.innerHTML='';
		(a.paymentsOverdue||[]).slice(0,8).forEach(p=>{
			const blocked = p.payable === false;
			const reasons = Array.isArray(p.blockedReasons) ? p.blockedReasons : [];
			const badgeClass = blocked ? 'badge badge-stop' : 'badge badge-ok';
			const badgeText = blocked ? 'Blocked' : 'Payable';
			const reasonText = blocked && reasons.length ? reasons[0] : '';
			const reasonTitle = reasons.length ? reasons.join(' • ') : '';
			overdue.appendChild(li(`
				<div class="min-w-0 flex-1">
					<a href="${p.url}" target="_blank"
						class="truncate underline decoration-slate-300 hover:decoration-rose-400"
						title="${reasonTitle}">${p.title}</a>
					<span class="${badgeClass}" title="${reasonTitle}">${badgeText}</span>
					${reasonText ? `<span class="reason" title="${reasonTitle}">${reasonText}</span>` : ``}
				</div>
				<div class="shrink-0 text-right">
					<span class="text-rose-600 font-bold block">${fmtMYR(p.amount)}</span>
					<span class="text-xs text-[var(--muted)] block">${fmtDate(p.dueDate)}</span>
				</div>
			`));
		});

		const upcoming = document.getElementById('upcomingList'); upcoming.innerHTML='';
		(a.paymentsUpcoming||[]).slice(0,8).forEach(p=>{
			const blocked = p.payable === false;
			const reasons = Array.isArray(p.blockedReasons) ? p.blockedReasons : [];
			const badgeClass = blocked ? 'badge badge-warn' : 'badge badge-ok';
			const badgeText = blocked ? 'Blocked' : 'Payable';
			const reasonText = blocked && reasons.length ? reasons[0] : '';
			const reasonTitle = reasons.length ? reasons.join(' • ') : '';
			upcoming.appendChild(li(`
				<div class="min-w-0 flex-1">
					<a href="${p.url}" target="_blank"
						class="truncate underline decoration-slate-300 hover:decoration-rose-400"
						title="${reasonTitle}">${p.title}</a>
					<span class="${badgeClass}" title="${reasonTitle}">${badgeText}</span>
					${reasonText ? `<span class="reason" title="${reasonTitle}">${reasonText}</span>` : ``}
				</div>
				<div class="shrink-0 text-right">
					<span class="${blocked ? 'text-amber-600':'text-emerald-600'} font-bold block">${fmtMYR(p.amount)}</span>
					<span class="text-xs text-[var(--muted)] block">${fmtDate(p.dueDate)}</span>
				</div>
			`));
		});

		const deliv = document.getElementById('deliverableIssues'); deliv.innerHTML='';
		(a.deliverablesIssues||[]).slice(0,8).forEach(d=>{
			deliv.appendChild(li(`
				<a href="${d.url}" target="_blank" class="truncate underline decoration-slate-300 hover:decoration-rose-400">${d.title}</a>
				<span class="text-xs font-bold ${d.status==='Rejected'?'text-rose-600':'text-slate-600'}">${d.status}</span>
			`));
		});

		const risk = document.getElementById('milestonesRisk'); risk.innerHTML='';
		(a.milestonesRisk||[]).slice(0,8).forEach(m=>{
			risk.appendChild(li(`
				<a href="${m.url}" target="_blank" class="truncate underline decoration-slate-300 hover:decoration-rose-400">${m.title}</a>
				<span class="text-xs font-bold text-rose-600">${m.riskStatus}</span>
			`));
		});
	}

	let cashflowChart;
	function renderCashflow(cf) {
		const el = document.getElementById('cashflowChart');
		if (!el) return;

		const data = Array.isArray(cf) ? cf.slice() : [];
		if (cashflowChart) { try { cashflowChart.destroy(); } catch(e){} cashflowChart = null; }
		if (data.length === 0) {
			const ctx = el.getContext('2d');
			if (ctx) ctx.clearRect(0, 0, el.width, el.height);
			return;
		}

		const labels = data.map(r => r.ym);
		const scheduled = data.map(r => r.scheduled || 0);
		const paid = data.map(r => r.paid || 0);

		cashflowChart = new Chart(el.getContext('2d'), {
			type: 'bar',
			data: {
				labels,
				datasets: [
					{ label: 'Scheduled', data: scheduled, backgroundColor: '#0f2133', borderRadius: 6 },
					{ label: 'Paid', data: paid, backgroundColor: '#e11d48', borderRadius: 6 }
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: { legend: { position: 'bottom' } },
				scales: {
					x: { grid: { display: false } },
					y: { beginAtZero: true, grid: { color: '#e5e7eb' } }
				}
			}
		});
	}

	function renderTopVendors(list){
		const ul = document.getElementById('topVendors'); if (!ul) return; ul.innerHTML = '';
		(list||[]).forEach(r => ul.insertAdjacentHTML('beforeend',
			`<li class="flex justify-between"><span class="truncate">${r.vendor}</span><span class="font-bold">${fmtMYR(r.amount)}</span></li>`));
	}

	function renderGates(gates){
		const wrap = document.getElementById('gatesWrap'); wrap.innerHTML='';
		(gates||[]).forEach(g=>{
			const pct = g.required>0 ? Math.round((g.approved/g.required)*100) : 0;
			const card = document.createElement('div');
			card.className='rounded border border-slate-200 p-4';
			card.innerHTML = `
				<div class="flex items-center justify-between">
					<p class="font-bold">${g.id}</p>
					<span class="text-xs ${g.blocked>0?'text-rose-600':'text-emerald-600'} font-bold">${g.blocked>0?'Blocked':'Clear'}</span>
				</div>
				<div class="mt-3">
					<div class="w-full h-2 bg-slate-200 rounded overflow-hidden">
						<div class="h-2 bg-emerald-600" style="width:${pct}%"></div>
					</div>
					<p class="mt-2 text-xs text-[var(--muted)]">
						Required ${g.required}
						• Approved ${g.approved}
						• Submitted ${g.submitted ?? 0}
						• Blocked ${g.blocked}
						• Milestones complete ${g.milestonesComplete}
					</p>
					${typeof g.gateApprovalRate === 'number' ? `
					<p class="mt-1 text-[10px] text-[var(--muted)]">
						Approval rate ${(g.gateApprovalRate*100).toFixed(0)}%
						• Submission rate ${(g.gateSubmissionRate*100).toFixed(0)}%
					</p>` : ``}
				</div>`;
			wrap.appendChild(card);
		});
	}

	// STATUS + DATA FLOW
	const statusEl = document.getElementById('status');

	async function autoSummary(){
		if (!dataCache) return;
		try {
			const resp = await fetch('/.netlify/functions/proxy', {
				method:'POST',
				headers:{'Content-Type':'application/json'},
				body: JSON.stringify({ type:'summary', data: dataCache })
			});
			const out = await resp.json().catch(()=>({}));
			document.getElementById('summaryOut').textContent = out.text || 'No response.';
		} catch (err) {
			document.getElementById('summaryOut').textContent = 'AI summary unavailable.';
		}
	}

	async function loadData(){
		statusEl.textContent = 'Loading…';
		try {
			const r = await fetch('/.netlify/functions/proxy', { headers:{'Accept':'application/json'} });
			if (!r.ok) throw new Error(`HTTP ${r.status}`);
			dataCache = await r.json();

			renderKPIs(dataCache.kpis || {});
			renderAlerts(dataCache.alerts || { paymentsOverdue: [], paymentsUpcoming: [], deliverablesIssues: [], milestonesRisk: [] });
			renderCashflow(dataCache.cashflow || []);
			renderGates(dataCache.gates || []);
			renderTopVendors(dataCache.topVendors || []);

			statusEl.textContent = '';
		} catch (err) {
			statusEl.textContent = `Failed to load data: ${err.message}`;
			console.error(err);
		}
	}

	document.getElementById('genSummary').addEventListener('click', autoSummary);

	// Boot
	loadData().then(autoSummary).catch(err=>console.error(err));
	</script>
</body>
</html>
