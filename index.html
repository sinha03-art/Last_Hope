<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Dashboard</title>
  
   <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ %3C/text%3E%3C/svg%3E">
  
  <!-- Fonts and libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
  :root{
    --bg:#f6f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#e11d48; --border:#e5e7eb;
    --h1:1.375rem; --h2:1.125rem; --h3:1rem; --body:.9375rem; --small:.8125rem;
  }
  html,body{height:100%}
  body{
    font-family:"Lato",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg); color:var(--ink); font-size:var(--body);
  }
  h1{font-size:var(--h1); font-weight:900; letter-spacing:.01em; text-transform:uppercase}
  h2{font-size:var(--h2); font-weight:800; letter-spacing:.01em}
  h3{font-size:var(--h3); font-weight:800}
  .small{font-size:var(--small); color:var(--muted)}
  .upper{text-transform:uppercase}
  .nav-sep{box-shadow: inset 0 -1px 0 0 rgba(255,255,255,0.06);}
  .pill{font-weight:800;font-size:.625rem; line-height:1; padding:.25rem .4rem; border-radius:999px; background:#ef4444; color:#fff;}
  .hr{height:1px; background: var(--border);}
  .top-shadow{box-shadow: 0 1px 0 rgba(15,33,51,.06);}
  .kpi{border:1px solid var(--border); border-radius:.75rem; padding:1rem; background:var(--panel)}
  .card{background:var(--panel)}
  </style>
</head>
<body>
<div class="min-h-screen grid grid-cols-[260px_1fr]">

  <!-- Sidebar -->
  <aside class="bg-[#0f2133] text-[#e2e8f0]">
    <div class="p-6">
      <!-- 16:9 responsive wrapper -->
      <div class="relative w-full overflow-hidden rounded mb-3" style="padding-top:56.25%">
        <iframe
          src="https://player.vimeo.com/video/1121406919?autoplay=1&muted=1&loop=1&title=0&byline=0&portrait=0"
          title="Project intro"
          class="absolute inset-0 w-full h-full"
          frameborder="0"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          loading="lazy">
      </iframe
    </div>

      <div class="leading-tight">
        <p class="font-black tracking-wide upper">JOOBIN</p>
        <p class="text-[10px] opacity-70">Assets</p>
      </div>

      <!-- Short property write-up -->
      <div class="mt-3 text-[13px] text-white">
        <p><strong>Project:</strong> JOOBIN Residence</p>
        <p><strong>Status:</strong> 3D design stage. Construction not started.</p>
        <p class="text-[12px] opacity-70">Oneâ€‘minute ambient clip sharing corrected code and dashboard direction.</p>
      </div>
    </div>

    <nav class="mt-4 text-sm">
      <div class="px-6 py-3 text-[.8rem] tracking-widest uppercase opacity-60">Pages</div>
      <ul>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Dosier</span></a></li>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="deliverables.html"><span>Gate Deliverables</span><span class="pill">New</span></a></li>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Project Stage</span></a></li>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Media</span><span class="pill">New</span></a></li>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Tasks</span></a></li>
        <li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>Forms</span></a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main -->
  <div class="flex flex-col">
    <header class="card top-shadow">
      <div class="h-14 flex items-center justify-between px-6">
        <h1>Dashboard</h1>
        <div class="text-xs opacity-70">JOOBIN</div>
      </div>
    </header>

    <main class="p-6 space-y-6">
      <!-- KPI strip -->
      <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="kpi"><p class="text-xs upper text-[var(--muted)]">Paid vs Budget</p><p id="kpiPaidVsBudget" class="text-3xl font-black">0%</p></div>
        <div class="kpi"><p class="text-xs upper text-[var(--muted)]">Deliverables Approved</p><p id="kpiDeliverables" class="text-3xl font-black">0%</p></div>
        <div class="kpi"><p class="text-xs upper text-[var(--muted)]">Milestones At Risk</p><p id="kpiRisk" class="text-3xl font-black">0</p></div>
        <div class="kpi">
          <p class="text-xs upper text-[var(--muted)]">Next 30d Due</p>
          <p id="kpiNext30" class="text-3xl font-black">RM 0</p>
          <p id="kpiNext30Count" class="text-xs text-[var(--muted)] mt-1">0 items</p>
        </div>
      </section>

      <!-- Attention + Forecast -->
      <section class="grid grid-cols-12 gap-6">
        <div class="col-span-12 lg:col-span-6 card rounded border border-slate-200 p-6">
          <h3 class="font-black tracking-wide mb-3 upper">Attention Board</h3>

          <p class="text-xs upper text-[var(--muted)] mb-2">Overdue Payments</p>
          <ul id="overdueList" class="space-y-2 text-sm mb-4"></ul>

          <div class="hr my-4"></div>

          <p class="text-xs upper text-[var(--muted)] mb-2">Payment Forecast (by month)</p>
          <canvas id="forecastChart" height="120"></canvas>
        </div>

        <!-- Top Vendors -->
        <div class="col-span-12 lg:col-span-6 card rounded border border-slate-200 p-6">
          <h3 class="font-black tracking-wide mb-3 upper">Top Vendors Outstanding</h3>
          <ul id="topVendors" class="space-y-2 text-sm"></ul>
        </div>
      </section>

      <!-- Gate Progress (reworked) -->
      <section class="card rounded border border-slate-200 p-6">
        <h3 class="font-black tracking-wide mb-3 upper">Gate Progress</h3>
        <div id="gatesWrap" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </section>

      <!-- AI Summary -->
      <section class="card rounded border border-slate-200 p-6">
        <div class="flex items-center justify-between">
          <h3 class="font-black tracking-wide">Weekly AI Summary</h3>
          <button id="genSummary" class="px-4 py-2 bg-rose-600 text-white font-bold rounded hover:bg-rose-700">Generate</button>
        </div>
        <div id="summaryOut" class="mt-4 text-sm whitespace-pre-line"></div>
      </section>
    </main>
  </div>
</div>

<script>
// Utilities
const fmtMYR = v => (v||0).toLocaleString('en-MY', { style:'currency', currency:'MYR', maximumFractionDigits:0 });
const fmtDate = s => s ? new Date(s).toLocaleDateString('en-GB', { day:'2-digit', month:'short' }) : 'â€”';
function li(html){ const el=document.createElement('li'); el.className='flex justify-between gap-3'; el.innerHTML=html; return el; }
function daysFromNow(s){
  if (!s) return Infinity;
  const d = new Date(s); const now = new Date();
  return Math.ceil((d - now) / (1000*60*60*24));
}

let dataCache = null;

// KPIs
function renderKPIs(k){
  document.getElementById('kpiPaidVsBudget').textContent = ((k.paidVsBudget||0)*100).toFixed(1)+'%';
  document.getElementById('kpiDeliverables').textContent = ((k.deliverablesProgress||0)*100).toFixed(0)+'%';
  document.getElementById('kpiRisk').textContent = k.milestonesAtRisk||0;
  document.getElementById('kpiNext30').textContent = fmtMYR(k.next30?.amount||0);
  document.getElementById('kpiNext30Count').textContent = (k.next30?.count||0) + ' items';
}

// Attention - Overdue payments (Recipient, Amount, Due by)
function renderOverdue(a){
  const ul = document.getElementById('overdueList'); ul.innerHTML='';
  a.paymentsOverdue.slice(0,12).forEach(p=>{
    ul.appendChild(li(
      `<span class="truncate">${p.vendor || 'â€”'}</span>
       <span class="text-rose-600 font-bold">${fmtMYR(p.amount)}</span>
       <span class="text-xs text-[var(--muted)]">${fmtDate(p.dueDate)}</span>`
    ));
  });
}

// Forecast next 4 months (from cashflow.scheduled)
function buildForecast(cashflow){
  const now = new Date();
  const ym = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const months = [];
  for(let i=0;i<4;i++){
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    months.push(ym(d));
  }
  const idx = Object.fromEntries(cashflow.map(r => [r.ym, r]));
  return { months, values: months.map(m => idx[m]?.scheduled || 0) };
}

let forecastChart;
function renderForecast(cf){
  const ctx = document.getElementById('forecastChart').getContext('2d');
  const now = new Date();
  const { months, values } = buildForecast(cf);
  const labels = months.map((m,i)=>{
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    return d.toLocaleDateString('en-GB', { month:'short', year:'2-digit' });
  });
  if (forecastChart) forecastChart.destroy();
  forecastChart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{
      label:'Scheduled',
      data: values,
      tension:.3,
      borderColor:'#0f2133',
      backgroundColor:'rgba(15,33,51,.08)',
      fill:true, pointRadius:3, pointBackgroundColor:'#0f2133'
    }]},
    options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'#e5e7eb'}}}}
  });
}

// Gate Progress rework
function computeGateDerived(gateId, deliverables, milestones){
  const items = deliverables.filter(d => (d.gate || 'Uncategorized') === gateId);
  const required = items.length;
  const approved = items.filter(d => d.status === 'Approved').length;
  const blocked = items.filter(d => d.status === 'Rejected' || d.status === 'Missing').length;
  const dueSoon = items.filter(d => {
    const isApproved = d.status === 'Approved';
    const tgt = d.targetDue || d.dueDate;
    return !isApproved && daysFromNow(tgt) <= 14;
  }).length;
  const atRisk = (dataCache.milestones||[]).filter(m => (m.phase || 'Uncategorized') === gateId && m.riskStatus === 'At Risk').length;
  const pct = required > 0 ? Math.round((approved / required) * 100) : 0;
  return { required, approved, blocked, dueSoon, atRisk, pct };
}

function renderGates(gates){
  const wrap = document.getElementById('gatesWrap'); wrap.innerHTML='';
  const gateMap = Object.fromEntries(gates.map(g => [g.id || g.gate || 'Uncategorized', g]));
  const enriched = Object.keys(gateMap).map(id => {
    const base = gateMap[id];
    const d = computeGateDerived(id, (dataCache.deliverables||[]), (dataCache.milestones||[]));
    return { id, ...base, ...d };
  });
  enriched.sort((a,b) => {
    if ((b.atRisk||0) !== (a.atRisk||0)) return (b.atRisk||0) - (a.atRisk||0);
    return (a.pct||0) - (b.pct||0);
  });
  enriched.forEach(g=>{
    const riskBadge = g.atRisk > 0 ? `<span class="text-xs font-bold text-rose-600">At Risk ${g.atRisk}</span>`
                                   : `<span class="text-xs font-bold text-emerald-600">OK</span>`;
    const blockedCls = g.blocked > 0 ? 'text-rose-600' : 'text-slate-600';
    const dueSoonCls = g.dueSoon > 0 ? 'text-amber-600' : 'text-slate-600';

    const card = document.createElement('div');
    card.className='rounded border border-slate-200 p-4';
    card.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <p class="font-bold">${g.id}</p>
        ${riskBadge}
      </div>
      <div class="w-full h-2 bg-slate-200 rounded overflow-hidden">
        <div class="h-2 bg-emerald-600" style="width:${Math.min(100, Math.max(0, g.pct||0))}%"></div>
      </div>
      <p class="mt-2 text-xs text-[var(--muted)]">Approved ${g.approved||0} / ${g.required||0} (${g.pct||0}%)</p>
      <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
        <div class="${blockedCls}"><span class="font-bold">${g.blocked||0}</span> Blocked</div>
        <div class="${dueSoonCls}"><span class="font-bold">${g.dueSoon||0}</span> Due â‰¤ 14d</div>
        <div class="${g.atRisk>0 ? 'text-rose-600' : 'text-slate-600'}"><span class="font-bold">${g.atRisk||0}</span> Milestones Risk</div>
      </div>
    `;
    wrap.appendChild(card);
  });
}

// Top Vendors
function renderTopVendors(list){
  const ul = document.getElementById('topVendors'); ul.innerHTML='';
  list.forEach(r => ul.insertAdjacentHTML('beforeend',
    `<li class="flex justify-between"><span class="truncate">${r.vendor}</span><span class="font-bold">${fmtMYR(r.amount)}</span></li>`
  ));
}

async function loadData(){
  const r = await fetch('/.netlify/functions/proxy');
  if (!r.ok) throw new Error('Failed to fetch project data');
  dataCache = await r.json();
  renderKPIs(dataCache.kpis);
  renderOverdue(dataCache.alerts);
  renderForecast(dataCache.cashflow);
  renderGates(dataCache.gates);
  renderTopVendors(dataCache.topVendors);
}

// AI Summary (manual)
let summaryOnce = false;
async function autoSummary(){
  if (summaryOnce || !dataCache) return;
  summaryOnce = true;
  const resp = await fetch('/.netlify/functions/proxy', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ type:'summary', data: dataCache })
  });
  const out = await resp.json();
  document.getElementById('summaryOut').textContent = out.text || 'No response.';
}
document.getElementById('genSummary').addEventListener('click', autoSummary);

loadData().catch(err=>console.error(err));
</script>
</body>
</html>