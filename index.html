<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Project Dashboard</title>

	<!-- Lato (Author: Łukasz Dziedzic / tyPoland) -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<!-- Regular + Bold/Black weights -->
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

	<!-- Tailwind -->
	<script src="https://cdn.tailwindcss.com"></script>

	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

	<style>
		:root{
			--bg:#f1f3f5;
			--panel:#ffffff;
			--ink:#0f172a;
			--muted:#64748b;
			--brand:#e11d48; /* rose/red accent */
			--nav:#0f2133;   /* deep navy */
			--nav-ink:#e2e8f0;
		}
		html,body{height:100%}
		body{font-family:"Lato",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--ink);}
		.nav-sep{box-shadow: inset 0 -1px 0 0 rgba(255,255,255,0.06);}
		.pill{font-weight:800;font-size:.625rem; line-height:1; padding:.25rem .4rem; border-radius:999px; background:#ef4444; color:#fff;}
		.hr{height:1px; background: #e5e7eb;}
		.mini-bar{width:14px; border-radius:3px; background:#0f2133; position:relative; overflow:hidden}
		.mini-bar::after{content:""; position:absolute; bottom:0; left:0; right:0; height:30%; background:#ef4444;}
		.gauge { width: 220px; height: 110px; border-top-left-radius: 220px; border-top-right-radius: 220px;
			background: conic-gradient(#e11d48 0 40%, #f97316 40% 70%, #10b981 70% 100%); position:relative; overflow:hidden;}
		.gauge::before{ content:""; position:absolute; left:50%; top:100%; transform:translate(-50%,-50%); width:170px; height:170px; border-radius:100%;
			background:var(--panel); box-shadow:0 -1px 0 0 rgba(0,0,0,.04) inset;}
		.gauge-center{ position:absolute; left:50%; top:100%; transform:translate(-50%,-55%); text-align:center;}
		.top-shadow{box-shadow: 0 1px 0 rgba(15,33,51,.06);}
	</style>
</head>
<body>
	<div class="min-h-screen grid grid-cols-[260px_1fr]">

		<!-- Sidebar -->
		<aside class="bg-[var(--nav)] text-[var(--nav-ink)]">
			<div class="p-6 flex items-center gap-3">
				<div class="w-9 h-9 rounded bg-white/10 grid place-items-center">
					<div class="w-5 h-5 rotate-45 bg-[var(--brand)]"></div>
				</div>
				<div class="leading-tight">
					<p class="font-black tracking-wide">LOREM IPSUM</p>
					<p class="text-[10px] opacity-70">DOLOR SIT AMET</p>
				</div>
			</div>

			<nav class="mt-6 text-sm">
				<div class="px-6 py-3 text-[.8rem] tracking-widest uppercase opacity-60">Pages</div>
				<ul>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>PAGES</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>PROFILE</span><span class="pill">NEW</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>SETTINGS</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>PROJECTS</span><span class="pill">NEW</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>TASKS</span></a></li>
					<li class="nav-sep"><a class="flex items-center justify-between px-6 py-3 hover:bg-white/5" href="#"><span>FORMS</span></a></li>
				</ul>
			</nav>
		</aside>

		<!-- Main -->
		<div class="flex flex-col">

			<!-- Top bar -->
			<header class="bg-white top-shadow">
				<div class="h-14 flex items-center justify-between px-6">
					<div class="flex items-center gap-4">
						<button class="w-8 h-8 grid place-items-center rounded hover:bg-slate-100" aria-label="Menu">
							<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
							</svg>
						</button>
						<p class="font-black tracking-wide text-slate-700">DASHBOARD</p>
					</div>
					<div class="flex items-center gap-4">
						<div class="relative">
							<span class="absolute -top-1 -right-1 pill">5</span>
							<div class="w-8 h-8 rounded bg-slate-800 grid place-items-center">
								<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 00-7 7v3.764l-1.447 2.894A1 1 0 004.447 17h15.106a1 1 0 00.894-1.447L19 12.764V9a7 7 0 00-7-7z"/><path d="M6 19a6 6 0 0012 0H6z"/></svg>
							</div>
						</div>
						<div class="text-xs text-slate-500">LOREM IPSUM</div>
					</div>
				</div>
			</header>

			<!-- Content -->
			<main class="p-6 space-y-6">

				<!-- Top 3 tiles -->
				<section class="grid grid-cols-12 gap-4">
					<div class="col-span-12 md:col-span-5 bg-white rounded border border-slate-200 p-4">
						<canvas id="heroChartA" class="w-full h-40"></canvas>
						<div class="mt-3 w-full h-10 bg-slate-100 rounded grid place-items-center">
							<p class="text-xs text-slate-500">Overview A</p>
						</div>
					</div>
					<div class="col-span-12 md:col-span-5 bg-white rounded border border-slate-200 p-4">
						<canvas id="heroChartB" class="w-full h-40"></canvas>
						<div class="mt-3 w-full h-10 bg-slate-100 rounded grid place-items-center">
							<p class="text-xs text-slate-500">Overview B</p>
						</div>
					</div>
					<div class="col-span-12 md:col-span-2 bg-white rounded border border-slate-200 p-4">
						<canvas id="heroChartC" class="w-full h-52"></canvas>
					</div>
				</section>

				<!-- Middle row -->
				<section class="grid grid-cols-12 gap-6">
					<!-- Gauge + totals -->
					<div class="col-span-12 lg:col-span-8 bg-white rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide mb-4 text-slate-700">CONSECTETUER</h3>
						<div class="grid grid-cols-12 gap-6 items-center">
							<div class="col-span-12 md:col-span-4 flex justify-center">
								<div class="gauge">
									<div class="gauge-center">
										<p class="text-xs uppercase tracking-widest text-[var(--muted)]">Speed</p>
										<p id="gaugePct" class="text-2xl font-black">40%</p>
									</div>
								</div>
							</div>
							<div class="col-span-12 md:col-span-8 grid grid-cols-2 gap-6">
								<div>
									<p class="uppercase text-xs tracking-widest text-[var(--muted)]">Total</p>
									<p id="totalA" class="text-3xl font-black">20.256</p>
									<p class="text-[10px] text-rose-600 font-black mt-1">LOREM IPSUM</p>
								</div>
								<div>
									<p class="uppercase text-xs tracking-widest text-[var(--muted)]">Total</p>
									<p id="totalB" class="text-3xl font-black">20.256</p>
									<p class="text-[10px] text-rose-600 font-black mt-1">LOREM IPSUM</p>
								</div>
								<p id="midCopy" class="col-span-2 text-sm text-[var(--muted)] leading-relaxed">
									Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed diam.
								</p>
							</div>
						</div>
					</div>

					<!-- Alert metrics -->
					<div class="col-span-12 lg:col-span-4 bg-white rounded border border-slate-200 p-6">
						<div class="flex items-center gap-3 mb-4">
							<div class="w-12 h-12 rounded bg-rose-500 grid place-items-center text-white">
								<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l8 8-8 8-8-8 8-8z"/></svg>
							</div>
							<h3 class="font-black tracking-wide text-slate-700">CONSECTETUER</h3>
						</div>
						<p class="uppercase text-xs tracking-widest text-[var(--muted)]">Total</p>
						<p id="alertTotal" class="text-3xl font-black">13.25</p>
						<p class="text-[10px] text-rose-600 font-black mt-1">LOREM IPSUM</p>
						<div class="mt-4 flex items-end gap-3">
							<div class="mini-bar" style="height:62px"></div>
							<div class="mini-bar" style="height:76px"></div>
							<div class="mini-bar" style="height:58px"></div>
							<div class="mini-bar" style="height:70px"></div>
						</div>
						<p class="mt-4 text-sm text-[var(--muted)]">
							Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed diam
						</p>
					</div>
				</section>

				<!-- Bottom row -->
				<section class="grid grid-cols-12 gap-6">
					<div class="col-span-12 lg:col-span-6 bg-white rounded border border-slate-200 p-6">
						<div class="flex items-center gap-2">
							<h3 class="font-black tracking-wide text-slate-700">DIAM NONUMMY</h3>
						</div>
						<p id="descA" class="text-sm text-[var(--muted)] mt-2">
							Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy.
						</p>
						<div class="hr my-5"></div>
						<div class="grid grid-cols-[1fr_auto] gap-6 items-center">
							<canvas id="areaChart" height="90"></canvas>
							<span class="pill">NEW</span>
						</div>
					</div>

					<div class="col-span-12 lg:col-span-6 bg-white rounded border border-slate-200 p-6">
						<h3 class="font-black tracking-wide text-slate-700">TOTAL</h3>
						<div class="flex items-baseline gap-4 mt-2">
							<p id="totalMain" class="text-3xl font-black">35.256</p>
							<span class="pill">NEW</span>
						</div>
						<div class="mt-6">
							<div class="w-full h-3 rounded bg-slate-200 overflow-hidden">
								<div id="progA" class="h-full bg-emerald-600" style="width:74%"></div>
							</div>
							<div class="mt-4 w-full h-3 rounded bg-slate-200 overflow-hidden">
								<div id="progB" class="h-full bg-slate-800" style="width:60%"></div>
							</div>
						</div>
						<div class="mt-6 grid grid-cols-2 gap-6">
							<canvas id="barChart" height="80"></canvas>
							<canvas id="doughnutChart" height="80"></canvas>
						</div>
					</div>
				</section>

				<!-- AI Summary -->
				<section class="bg-white rounded border border-slate-200 p-6">
					<div class="flex items-center justify-between">
						<h3 class="font-black tracking-wide text-slate-700">Weekly AI Summary</h3>
						<button id="genSummary" class="px-4 py-2 bg-rose-600 text-white font-bold rounded hover:bg-rose-700">Generate</button>
					</div>
					<div id="summaryOut" class="mt-4 text-sm text-slate-700 whitespace-pre-line"></div>
				</section>

			</main>
		</div>
	</div>

	<script>
		// Charts palette
		const brand = '#e11d48', navy = '#0f2133', slate = '#64748b';

		const heroA = new Chart(document.getElementById('heroChartA'), {
			type: 'bar',
			data: { labels:['A','B','C','D','E'], datasets:[{ data:[12,18,14,20,16], backgroundColor:[navy,navy,navy,brand,navy], borderRadius:6 }] },
			options: { plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{grid:{color:'#eee'}, beginAtZero:true }} }
		});
		const heroB = new Chart(document.getElementById('heroChartB'), {
			type: 'line',
			data: { labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets:[{ data:[10,12,11,15,19,17,20], borderColor:brand, backgroundColor:'rgba(225,29,72,.12)', fill:true, tension:.35, pointRadius:0 }]},
			options: { plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{grid:{color:'#eee'}}}}
		});
		const heroC = new Chart(document.getElementById('heroChartC'), {
			type: 'doughnut',
			data: { labels:['Done','In Progress','Blocked'], datasets:[{ data:[60,30,10], backgroundColor:['#10b981',navy,brand], borderWidth:0 }]},
			options: { cutout:'70%', plugins:{legend:{display:false}} }
		});

		const areaChart = new Chart(document.getElementById('areaChart'), {
			type: 'line',
			data: { labels:[], datasets:[{ data:[], fill:true, tension:.35, borderColor:brand, backgroundColor:'rgba(225,29,72,0.12)', pointRadius:0 }]},
			options: { plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}, ticks:{color:slate}}, y:{grid:{color:'#eee'}, ticks:{color:slate}, beginAtZero:true}}}
		});
		const barChart = new Chart(document.getElementById('barChart'), {
			type: 'bar',
			data: { labels:[], datasets:[{ data:[], backgroundColor:[], borderRadius:6 }]},
			options: { plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}, ticks:{color:slate}}, y:{grid:{color:'#eee'}, ticks:{color:slate}, beginAtZero:true}}}
		});
		const doughnutChart = new Chart(document.getElementById('doughnutChart'), {
			type: 'doughnut',
			data: { labels:['Approved','Submitted','Missing'], datasets:[{ data:[0,0,0], backgroundColor:['#10b981', '#f59e0b', brand], borderWidth:0 }]},
			options: { cutout:'70%', plugins:{ legend:{ position:'bottom', labels:{ color: slate } } } }
		});

		// Data wiring to Netlify function
		async function loadData() {
			try {
				const res = await fetch('/.netlify/functions/proxy');
				if (!res.ok) throw new Error('Failed to fetch data');
				const { milestones, deliverables, payments, kpis } = await res.json();

				document.getElementById('gaugePct').textContent = Math.round((kpis.deliverablesProgress||0)*100) + '%';
				document.getElementById('totalA').textContent = (kpis.paidVsBudget*100).toFixed(1);
				document.getElementById('totalB').textContent = kpis.overBudgetCount;
				document.getElementById('alertTotal').textContent = milestones.filter(m=>m.riskStatus==='At Risk').length;
				document.getElementById('totalMain').textContent = payments.filter(p=>p.status==='Paid').reduce((s,p)=>s+(p.amount||0),0).toLocaleString('en-US',{minimumFractionDigits:3, maximumFractionDigits:3});

				document.getElementById('progA').style.width = Math.min(100, (kpis.paidVsBudget*100)).toFixed(0)+'%';
				document.getElementById('progB').style.width = Math.min(100, (kpis.deliverablesProgress*100)).toFixed(0)+'%';

				const byMonth = {};
				payments.forEach(p=>{
					const d = p.dueDate ? new Date(p.dueDate) : null;
					if(!d) return;
					const key = `${d.getFullYear()}-${(d.getMonth()+1+'').padStart(2,'0')}`;
					byMonth[key] = (byMonth[key]||0) + (p.amount||0);
				});
				const labels = Object.keys(byMonth).sort();
				areaChart.data.labels = labels;
				areaChart.data.datasets[0].data = labels.map(k=>byMonth[k]);
				areaChart.update();

				const gateCounts = {};
				deliverables.forEach(d=>{ gateCounts[d.gate||'Uncategorized'] = (gateCounts[d.gate||'Uncategorized']||0) + 1; });
				const gates = Object.keys(gateCounts);
				barChart.data.labels = gates;
				barChart.data.datasets[0].data = gates.map(g=>gateCounts[g]);
				barChart.data.datasets[0].backgroundColor = gates.map((g,i)=> i===gates.length-1 ? brand : navy);
				barChart.update();

				const approved = deliverables.filter(d=>d.status==='Approved').length;
				const submitted = deliverables.filter(d=>d.status==='Submitted').length;
				const missing = deliverables.length - approved - submitted;
				doughnutChart.data.datasets[0].data = [approved, submitted, Math.max(0, missing)];
				doughnutChart.update();

			} catch (e) {
				console.error(e);
			}
		}

		document.getElementById('genSummary').addEventListener('click', async ()=>{
			try{
				const res = await fetch('/.netlify/functions/proxy');
				const data = await res.json();
				const resp = await fetch('/.netlify/functions/proxy', {
					method:'POST',
					headers:{'Content-Type':'application/json'},
					body: JSON.stringify({ type:'summary', data })
				});
				const out = await resp.json();
				document.getElementById('summaryOut').textContent = out.text || 'No response.';
			}catch(e){
				document.getElementById('summaryOut').textContent = 'Error generating summary.';
			}
		});

		loadData();
	</script>
</body>
