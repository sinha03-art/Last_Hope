<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JOOBIN Command Center</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüèóÔ∏è%3C/text%3E%3C/svg%3E"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }
    
    .neon-text {
      color: #22d3ee;
      text-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee, 0 0 30px #22d3ee;
    }
    
    .card-header {
      background: linear-gradient(135deg, #164e63 0%, #0e7490 100%);
      border-bottom: 2px solid #22d3ee;
    }
    
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.3; }
    }
    
    .blink {
      animation: blink 2s infinite;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-paid { background: #10b981; color: white; }
    .status-outstanding { background: #f59e0b; color: white; }
    .status-overdue { background: #ef4444; color: white; }
    
    .progress-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 4px solid #334155;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
    
    .progress-complete { border-color: #22d3ee; background: rgba(34, 211, 238, 0.1); }
    .progress-active { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
  </style>
</head>
<body class="flex">
  <!-- Sidebar -->
  <aside class="w-80 bg-slate-900 border-r border-slate-700 p-6 flex flex-col gap-6 overflow-y-auto">
    <div>
      <h1 class="text-2xl font-bold neon-text mb-2">JOOBIN</h1>
      <p class="text-sm text-slate-400">Renovation Command Center</p>
    </div>
    
    <!-- Video -->
    <div class="rounded-lg overflow-hidden border border-slate-700">
      <iframe src="https://player.vimeo.com/video/1121406919?autoplay=1&muted=1&loop=1&background=1" 
              width="100%" height="180" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
    </div>
    
    <!-- Property Info -->
    <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
      <h3 class="font-semibold text-cyan-400 mb-3">Property</h3>
      <div class="text-sm space-y-2">
        <div><span class="text-slate-400">Location:</span> <span class="text-white">Sri Suria, Bukit Rimau</span></div>
        <div><span class="text-slate-400">Type:</span> <span class="text-white">Double-storey terrace</span></div>
        <div><span class="text-slate-400">Project ID:</span> <span class="text-white">HOUSE-4</span></div>
      </div>
    </div>
    
    <!-- Designer Portal -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
      <div class="p-3 bg-slate-700 border-b border-slate-600">
        <h3 class="font-semibold text-cyan-400 text-sm">Designer Portal</h3>
      </div>
      <iframe src="" 
              width="100%" height="400" frameborder="0"></iframe>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto">
    <div class="p-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 class="text-3xl font-bold neon-text">Dashboard</h2>
          <p class="text-slate-400 mt-1">Real-time project overview</p>
        </div>
        <a href="" target="_blank" 
           class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
          <span>üì§</span> Upload Deliverable
        </a>
      </div>
      
      <!-- KPI Cards -->
      <div id="kpis" class="grid grid-cols-4 gap-6 mb-8">
        <!-- KPIs will be inserted here -->
      </div>
      
      <!-- Attention Board -->
      <div class="bg-slate-800 rounded-xl border border-slate-700 mb-8">
        <div class="card-header p-4">
          <h3 class="text-xl font-bold neon-text blink">‚ö†Ô∏è ATTENTION BOARD</h3>
        </div>
        <div class="p-6" id="attention-board">
          <!-- Attention items will be inserted here -->
        </div>
      </div>
      
      <!-- Project Stage -->
      <div class="bg-slate-800 rounded-xl border border-slate-700 mb-8">
        <div class="card-header p-4">
          <h3 class="text-xl font-bold neon-text">PROJECT STAGE</h3>
        </div>
        <div class="p-6" id="project-stage">
          <!-- Project stage will be inserted here -->
        </div>
      </div>
      
      <!-- Top Vendors -->
      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="card-header p-4">
          <h3 class="text-xl font-bold neon-text">TOP VENDORS</h3>
        </div>
        <div class="p-6" id="top-vendors">
          <!-- Vendors will be inserted here -->
        </div>
      </div>
    </div>
  </main>
    <script>
  async function loadDashboard() {
    try {
      console.log('üöÄ Fetching data...');
      const res = await fetch('/.netlify/functions/proxy');
      
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      
      const data = await res.json();
      console.log('‚úÖ Data loaded:', data);
      
      renderKPIs(data);
      renderAttentionBoard(data);
      renderProjectStage(data);
      renderTopVendors(data);
      
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert('Dashboard error: ' + error.message);
    }
  }
  
  function renderKPIs(data) {
    const kpis = data.kpis || {};
    
    // Use direct values from proxy
    const budget = kpis.budgetMYR || 1418996.10;
    const paid = kpis.paidMYR || 0;
    const remaining = kpis.remainingMYR || (budget - paid);
    const approved = kpis.deliverablesApproved || 0;
    const total = kpis.deliverablesTotal || 0;
    
    const container = document.getElementById('kpis');
    if (!container) {
      console.warn('‚ö†Ô∏è #kpis not found');
      return;
    }
    
    container.innerHTML = `
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="text-slate-400 text-sm mb-2">Total Budget</div>
        <div class="text-3xl font-bold text-white">RM ${budget.toLocaleString()}</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="text-slate-400 text-sm mb-2">Paid</div>
        <div class="text-3xl font-bold text-green-400">RM ${Math.round(paid).toLocaleString()}</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="text-slate-400 text-sm mb-2">Remaining</div>
        <div class="text-3xl font-bold text-cyan-400">RM ${Math.round(remaining).toLocaleString()}</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
        <div class="text-slate-400 text-sm mb-2">Deliverables</div>
        <div class="text-3xl font-bold text-white">${approved}/${total}</div>
      </div>
    `;
    
    console.log('‚úÖ KPIs:', {budget, paid, remaining, approved, total});
  }
  
  function renderAttentionBoard(data) {
    const paymentsSchedule = data.paymentsSchedule || {};
    const overdue = paymentsSchedule.overdue || [];
    const milestones = data.milestones || [];
    
    const container = document.getElementById('attention-board');
    if (!container) {
      console.warn('‚ö†Ô∏è #attention-board not found');
      return;
    }
    
    let html = '';
    
    // Overdue Payments
    if (overdue.length > 0) {
      html += '<div class="mb-6">';
      html += '<h4 class="font-semibold text-red-400 mb-3">üö® OVERDUE PAYMENTS</h4>';
      html += '<div class="space-y-2">';
      
      overdue.forEach(p => {
        html += `
          <div class="bg-slate-700 rounded-lg p-4">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-white">${p.paymentFor || 'Untitled'}</div>
                <div class="text-sm text-slate-400 mt-1">${p.vendor || 'Unknown'}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-red-400">RM ${(p.amount || 0).toLocaleString()}</div>
                <div class="text-xs text-slate-400 mt-1">Due: ${p.dueDate || 'N/A'}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
    }
    
    // At-Risk Milestones
    const atRisk = milestones.filter(m => m.risk === 'At Risk' || m.status === 'At Risk');
    if (atRisk.length > 0) {
      html += '<div class="mb-6">';
      html += '<h4 class="font-semibold text-orange-400 mb-3">‚ö†Ô∏è AT-RISK MILESTONES</h4>';
      html += '<div class="space-y-2">';
      
      atRisk.forEach(m => {
        html += `
          <div class="bg-slate-700 rounded-lg p-4">
            <div class="font-semibold text-white">${m.title || 'Untitled'}</div>
            <div class="text-sm text-slate-400 mt-1">${m.phase || 'N/A'}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
    }
    
    if (html === '') {
      html = '<div class="text-slate-400 text-center py-8">‚úÖ All clear! No urgent items.</div>';
    }
    
    container.innerHTML = html;
    console.log('‚úÖ Attention Board:', {overdue: overdue.length, atRisk: atRisk.length});
  }
  
  function renderProjectStage(data) {
    const gates = data.gates || [];
    const milestones = data.milestones || [];
    
    const container = document.getElementById('project-stage');
    if (!container) {
      console.warn('‚ö†Ô∏è #project-stage not found');
      return;
    }
    
    // Gate Timeline
    let gateHTML = '';
    gates.forEach(g => {
      const pct = g.total > 0 ? Math.round((g.approved / g.total) * 100) : 0;
      const statusClass = pct === 100 ? 'progress-complete' : 'progress-active';
      
      gateHTML += `
        <div class="text-center">
          <div class="progress-circle ${statusClass} mx-auto">${pct}%</div>
          <div class="text-sm mt-2 text-slate-300 font-semibold">${g.gate || 'Unknown'}</div>
        </div>
      `;
    });
    
    // Active Milestones
    let milestonesHTML = '';
    milestones.slice(0, 3).forEach(m => {
      const risk = m.risk || m.status || 'Unknown';
      const statusClass = risk.includes('Risk') ? 'status-overdue' : 'status-paid';
      
      milestonesHTML += `
        <div class="bg-slate-700 rounded-lg p-4">
          <div class="font-semibold text-white mb-2">${m.title || 'Untitled'}</div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-slate-400">${m.phase || 'N/A'}</span>
            <span class="status-badge ${statusClass}">${risk}</span>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = `
      <div class="mb-6">
        <h4 class="font-semibold text-cyan-400 mb-4">Gate Timeline</h4>
        <div class="grid grid-cols-${gates.length} gap-4">${gateHTML}</div>
      </div>
      <div>
        <h4 class="font-semibold text-cyan-400 mb-4">Active Milestones</h4>
        <div class="grid grid-cols-3 gap-4">${milestonesHTML}</div>
      </div>
    `;
    
    console.log('‚úÖ Project Stage:', {gates: gates.length, milestones: milestones.length});
  }
  
  function renderTopVendors(data) {
    const vendors = data.topVendors || [];
    
    const container = document.getElementById('top-vendors');
    if (!container) {
      console.warn('‚ö†Ô∏è #top-vendors not found');
      return;
    }
    
    let html = '';
    
    vendors.slice(0, 5).forEach((v, i) => {
      const borderClass = i > 0 ? 'border-t border-slate-700' : '';
      
      html += `
        <div class="flex items-center justify-between py-4 ${borderClass}">
          <div>
            <div class="font-semibold text-white">${v.name || 'Unknown'}</div>
            <div class="text-sm text-slate-400">Rank #${i + 1}</div>
          </div>
          <div class="text-right">
            <div class="font-bold text-cyan-400">RM ${(v.paid || 0).toLocaleString()}</div>
          </div>
        </div>
      `;
    });
    
    if (html === '') {
      html = '<div class="text-slate-400 text-center py-8">No vendor data</div>';
    }
    
    container.innerHTML = html;
    console.log('‚úÖ Top Vendors:', vendors.length);
  }
  
  // Initialize
  console.log('üöÄ Dashboard initializing...');
  loadDashboard();
</script>
</body>
</html>
