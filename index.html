<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Connection Test: Part 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <main id="status-container" class="max-w-4xl w-full mx-auto text-center p-8 space-y-6">
        <h1 class="text-3xl font-bold text-slate-100 mb-4">Running Connection Tests...</h1>
        <!-- Test 1: Milestones -->
        <div id="milestones-test" class="p-6 rounded-lg bg-slate-800/50 border border-slate-700">
            <h2 class="text-xl font-bold text-slate-300">1. Project Milestones Database</h2>
            <p class="text-slate-400 mt-2">Attempting connection...</p>
        </div>
        <!-- Test 2: Deliverables -->
        <div id="deliverables-test" class="p-6 rounded-lg bg-slate-800/50 border border-slate-700">
            <h2 class="text-xl font-bold text-slate-300">2. Gate Deliverables Database</h2>
             <p class="text-slate-400 mt-2">Attempting connection...</p>
        </div>
        <!-- Test 3: Payments -->
        <div id="payments-test" class="p-6 rounded-lg bg-slate-800/50 border border-slate-700">
            <h2 class="text-xl font-bold text-slate-300">3. Payment Schedule Database</h2>
             <p class="text-slate-400 mt-2">Attempting connection...</p>
        </div>
    </main>
    <script>
        async function runConnectionTest() {
            const milestonesContainer = document.getElementById('milestones-test');
            const deliverablesContainer = document.getElementById('deliverables-test');
            const paymentsContainer = document.getElementById('payments-test');

            const renderResult = (container, success, title, dataList, errorMsg = '') => {
                const statusColor = success ? 'green' : 'red';
                const statusIcon = success ? '✅' : '❌';
                let dataHtml = '';
                if (success && dataList && dataList.length > 0) {
                    dataHtml = `<ul class="mt-4 text-left text-sm text-slate-400 list-disc list-inside bg-slate-800/50 p-4 rounded-md">${dataList.map(item => `<li>${item.title}</li>`).join('')}</ul>`;
                } else if (success) {
                    dataHtml = `<p class="text-sm text-slate-500 mt-2">Connection successful, but no records were found.</p>`;
                } else {
                    dataHtml = `<pre class="mt-4 text-left text-sm text-red-300 bg-slate-800/50 p-4 rounded-md whitespace-pre-wrap">${errorMsg}</pre>`;
                }

                container.innerHTML = `
                    <h2 class="text-xl font-bold text-${statusColor}-400">${statusIcon} ${title}</h2>
                    ${dataHtml}
                `;
            };

            try {
                const response = await fetch('/.netlify/functions/proxy');
                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.details || 'The server returned an unspecified error.');
                }
                
                // Render results for all three tests
                renderResult(milestonesContainer, data.milestones.success, 'Project Milestones: Connection Successful', data.milestones.data, data.milestones.error);
                renderResult(deliverablesContainer, data.deliverables.success, 'Gate Deliverables: Connection Successful', data.deliverables.data, data.deliverables.error);
                renderResult(paymentsContainer, data.payments.success, 'Payment Schedule: Connection Successful', data.payments.data, data.payments.error);

            } catch (error) {
                console.error('Fetch Failed:', error);
                const errorText = `A critical error occurred. This usually means the backend function crashed. Please check the Netlify Function logs for details. Error: ${error.message}`;
                renderResult(milestonesContainer, false, 'Project Milestones: Connection Failed', null, errorText);
                renderResult(deliverablesContainer, false, 'Gate Deliverables: Connection Failed', null, 'Test skipped due to critical error.');
                renderResult(paymentsContainer, false, 'Payment Schedule: Connection Failed', null, 'Test skipped due to critical error.');
            }
        }
        document.addEventListener('DOMContentLoaded', runConnectionTest);
    </script>
</body>
</html>

